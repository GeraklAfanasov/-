# Конфигурация Nginx для балансировки нагрузки между Flask инстансами
# Этот файл должен быть размещен в директории конфигурации Nginx

# Определяем группу серверов (upstream) для балансировки нагрузки
upstream flask_backend {
    # Метод балансировки: round-robin (по умолчанию)
    # Распределяет запросы по очереди между серверами
    
    # Первый инстанс Flask на порту 5001
    server localhost:5001;
    
    # Второй инстанс Flask на порту 5002
    server localhost:5002;
    
    # Третий инстанс Flask на порту 5003
    server localhost:5003;
}

# Основной серверный блок
server {
    # Порт, на котором Nginx будет принимать запросы
    listen 80;
    
    # Имя сервера (можно использовать localhost или IP адрес)
    server_name localhost;
    
    # Логирование доступа
    access_log logs/access.log;
    error_log logs/error.log;
    
    # Основной блок location для обработки всех запросов
    location / {
        # Проксируем запросы к группе серверов flask_backend
        proxy_pass http://flask_backend;
        
        # Устанавливаем заголовки для правильной работы прокси
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Таймауты для соединения
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
}
